<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swostik Construction - PO System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6">

<!-- HEADER -->
<div class="flex gap-4 mb-6">
  <img src="logo.jpg" class="w-20 h-20 object-contain rounded-full">
  <div>
    <h1 class="text-2xl font-bold text-red-600">Swostik Construction</h1>
    <p class="text-gray-500">Vendor Order / Purchase Order System</p>
  </div>
</div>

<!-- FORM -->
<div class="grid grid-cols-1 md:grid-cols-7 gap-3">
  <input id="vendor" list="vendorList" class="border p-2 rounded" placeholder="Vendor Name">
  <datalist id="vendorList"></datalist>

  <select id="site" class="border p-2 rounded">
    <option value="">Select Site</option>
    <option>Pepsicola Site</option>
    <option>Thimi Site</option>
    <option>Budhanilkantha Site</option>
    <option>Banepa Site</option>
  </select>

  <input id="product" class="border p-2 rounded" placeholder="Product">
  <input id="quantity" type="number" class="border p-2 rounded" placeholder="Qty">
  <input id="price" type="number" class="border p-2 rounded" placeholder="Price">
  <input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By">

  <select id="status" class="border p-2 rounded">
    <option>Pending</option>
    <option>Approved</option>
  </select>
</div>

<button onclick="addOrder()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded">
Add Order
</button>

<!-- SITE TABLES -->
<div id="tables" class="mt-10 space-y-10"></div>

<!-- SUMMARY -->
<div class="mt-10 border-t pt-6">
  <h2 class="text-xl font-bold text-red-600 mb-3">Site-Wise Total Summary</h2>

  <table class="w-full text-sm border" id="summaryTable">
    <thead class="bg-gray-200">
      <tr>
        <th class="border p-2">Site</th>
        <th class="border p-2">Total Amount</th>
      </tr>
    </thead>
    <tbody id="summaryBody"></tbody>
    <tfoot>
      <tr class="bg-gray-100 font-bold">
        <td class="border p-2">Grand Total</td>
        <td class="border p-2" id="grandTotal">0</td>
      </tr>
    </tfoot>
  </table>

  <div class="flex gap-4 mt-4">
    <button onclick="downloadSummaryPDF()"
      class="bg-blue-600 text-white px-5 py-2 rounded">
      Download Summary PDF
    </button>

    <button onclick="downloadSummaryExcel()"
      class="bg-green-600 text-white px-5 py-2 rounded">
      Download Summary Excel
    </button>
  </div>
</div>

</div>

<script>
/* ---------- NEPALI DATE ---------- */
function getNepaliDate() {
  const d = new Date();
  let y = d.getFullYear() + 56;
  let m = d.getMonth() + 9;
  let day = d.getDate();
  if (m > 12) { m -= 12; y++; }
  return `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
}

/* ---------- DATA ---------- */
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let sn = orders.length ? Math.max(...orders.map(o => o.sn)) + 1 : 1;

const vendorEl = document.getElementById('vendor');
const siteEl = document.getElementById('site');
const productEl = document.getElementById('product');
const quantityEl = document.getElementById('quantity');
const priceEl = document.getElementById('price');
const orderedByEl = document.getElementById('orderedBy');
const statusEl = document.getElementById('status');

/* ---------- ADD ORDER ---------- */
function addOrder() {
  if (!vendorEl.value || !siteEl.value || !productEl.value || !quantityEl.value || !priceEl.value) {
    alert('Fill all fields');
    return;
  }

  orders.push({
    sn: sn++,
    adDate: new Date().toLocaleDateString(),
    bsDate: getNepaliDate(),
    vendor: vendorEl.value,
    site: siteEl.value,
    product: productEl.value,
    qty: quantityEl.value,
    price: priceEl.value,
    total: quantityEl.value * priceEl.value,
    orderedBy: orderedByEl.value,
    status: statusEl.value
  });

  localStorage.setItem('orders', JSON.stringify(orders));
  renderTables();

  vendorEl.value = productEl.value = quantityEl.value = priceEl.value = orderedByEl.value = '';
}

/* ---------- RENDER TABLES ---------- */
function renderTables() {
  const container = document.getElementById('tables');
  container.innerHTML = '';

  const sites = [...new Set(orders.map(o => o.site))];

  sites.forEach(site => {
    const siteOrders = orders.filter(o => o.site === site);
    const siteTotal = siteOrders.reduce((s, o) => s + o.total, 0);

    let html = `
    <div>
      <h2 class="text-lg font-bold text-red-600 mb-2">
        ${site} (Total: Rs. ${siteTotal})
      </h2>

      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">SN</th>
            <th class="border p-2">Vendor</th>
            <th class="border p-2">Product</th>
            <th class="border p-2">Qty</th>
            <th class="border p-2">Rate</th>
            <th class="border p-2">Total</th>
            <th class="border p-2">Status</th>
            <th class="border p-2">Action</th>
          </tr>
        </thead>
        <tbody>`;

    siteOrders.forEach(o => {
      html += `
      <tr>
        <td class="border p-2">${o.sn}</td>
        <td class="border p-2">${o.vendor}</td>
        <td class="border p-2">${o.product}</td>
        <td class="border p-2">${o.qty}</td>
        <td class="border p-2">${o.price}</td>
        <td class="border p-2 font-bold">${o.total}</td>
        <td class="border p-2">${o.status}</td>
        <td class="border p-2 text-center">
          ${o.status === 'Pending'
            ? `<button onclick="approveOrder(${o.sn})"
                class="bg-green-600 text-white px-2 py-1 text-xs rounded">
                Approve
              </button>`
            : `<span class="text-green-700 font-semibold">Approved</span>`
          }
        </td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
    container.innerHTML += html;
  });

  renderSummary();
  renderVendorList();
}

/* ---------- APPROVE ---------- */
function approveOrder(sn) {
  const o = orders.find(x => x.sn === sn);
  if (!o) return;
  o.status = 'Approved';
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTables();
}

/* ---------- SUMMARY ---------- */
function renderSummary() {
  const body = document.getElementById('summaryBody');
  body.innerHTML = '';

  let grand = 0;
  const summary = {};

  orders.forEach(o => {
    summary[o.site] = (summary[o.site] || 0) + o.total;
  });

  Object.keys(summary).forEach(site => {
    grand += summary[site];
    body.innerHTML += `
      <tr>
        <td class="border p-2">${site}</td>
        <td class="border p-2 font-bold">${summary[site]}</td>
      </tr>`;
  });

  document.getElementById('grandTotal').innerText = grand;
}

/* ---------- SUMMARY PDF ---------- */
function downloadSummaryPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text('Swostik Construction', 14, 20);
  doc.setFontSize(12);
  doc.text('Site-Wise Amount Summary', 14, 28);

  doc.autoTable({
    startY: 35,
    html: '#summaryTable'
  });

  const y = doc.lastAutoTable.finalY + 20;
  doc.text('Authorized Signature:', 14, y);
  doc.line(60, y, 140, y);
  doc.text('Swostik Construction', 60, y + 6);

  doc.save('Site-Wise-Summary.pdf');
}

/* ---------- SUMMARY EXCEL ---------- */
function downloadSummaryExcel() {
  const table = document.getElementById('summaryTable').cloneNode(true);
  const wb = XLSX.utils.table_to_book(table, { sheet: 'Summary' });
  XLSX.writeFile(wb, 'Site-Wise-Summary.xlsx');
}

/* ---------- VENDOR AUTOCOMPLETE ---------- */
function renderVendorList() {
  const list = document.getElementById('vendorList');
  const vendors = [...new Set(orders.map(o => o.vendor))];
  list.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
}

renderTables();
</script>

</body>
</html>


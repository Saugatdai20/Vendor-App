<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swostik Construction - PO System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
@media print {
  body * { visibility: hidden; }
  .print-area, .print-area * { visibility: visible; }
  .print-area { position:absolute; left:0; top:0; width:100%; }
}
</style>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow">

<!-- HEADER -->
<div class="flex gap-4 mb-6">
<img src="logo.jpg" class="w-20 h-20 rounded-full object-contain">
<div>
<h1 class="text-2xl font-bold text-red-600">Swostik Construction</h1>
<p class="text-gray-500">Vendor Order / Purchase Order System</p>
</div>
</div>

<!-- FORM -->
<div class="grid grid-cols-1 md:grid-cols-10 gap-3">
<input id="datetime" readonly class="border p-2 rounded bg-gray-100">
<input id="vendor" class="border p-2 rounded" placeholder="Vendor Name">
<input id="vatpan" class="border p-2 rounded" placeholder="VAT / PAN No">

<select id="site" class="border p-2 rounded">
<option value="">Select Site</option>
<option>Pepsicola Site</option>
<option>Thimi Site</option>
<option>Budhanilkantha Site</option>
<option>Banepa Site</option>
</select>

<input id="product" class="border p-2 rounded" placeholder="Product">
<input id="qty" type="number" class="border p-2 rounded" placeholder="Qty">
<input id="rate" type="number" class="border p-2 rounded" placeholder="Rate">
<input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By">

<select id="status" class="border p-2 rounded">
<option>Pending</option>
<option>Approved</option>
</select>
</div>

<button onclick="saveOrder()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded">
Save Order
</button>

<!-- SITE TABLES -->
<div id="siteTables" class="mt-10"></div>

<!-- SUMMARY -->
<div id="summarySection" class="mt-12 print-area">
<h2 class="text-lg font-bold text-red-600">Site-Wise Total Summary</h2>
<p id="summaryDT" class="text-sm text-gray-600 mb-2"></p>

<table class="w-full border text-sm">
<thead class="bg-gray-200">
<tr>
<th class="border p-2">Site</th>
<th class="border p-2">Total Amount (Rs)</th>
</tr>
</thead>
<tbody id="summary"></tbody>
<tfoot>
<tr class="bg-gray-100 font-bold">
<td class="border p-2">Grand Total</td>
<td class="border p-2" id="grandTotal"></td>
</tr>
</tfoot>
</table>
</div>

<div class="flex gap-3 mt-4">
<button onclick="printSummary()" class="bg-gray-700 text-white px-4 py-2 rounded">Print Summary</button>
<button onclick="summaryPDF()" class="bg-red-600 text-white px-4 py-2 rounded">Summary PDF</button>
<button onclick="summaryExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Summary Excel</button>
</div>

</div>

<script>
/* AUTO DATE TIME */
function autoDT(){
datetime.value=new Date().toLocaleDateString()+" "+new Date().toLocaleTimeString();
}
autoDT();

/* DATA */
let orders=JSON.parse(localStorage.getItem('orders'))||[];
let sn=orders.length?Math.max(...orders.map(o=>o.sn))+1:1;
let editIndex=null;

/* SAVE / UPDATE */
function saveOrder(){
if(!vendor.value||!vatpan.value||!site.value||!product.value||!qty.value||!rate.value)
return alert('Fill all fields');

const data={
sn:editIndex===null?sn++:orders[editIndex].sn,
datetime:datetime.value,
vendor:vendor.value,
vatpan:vatpan.value,
site:site.value,
product:product.value,
qty:+qty.value,
rate:+rate.value,
total:+qty.value*+rate.value,
orderedBy:orderedBy.value,
status:status.value
};

editIndex===null?orders.push(data):orders[editIndex]=data;
localStorage.setItem('orders',JSON.stringify(orders));
clearForm();render();
}

/* CLEAR FORM */
function clearForm(){
vendor.value=vatpan.value=product.value=qty.value=rate.value=orderedBy.value='';
site.value='';status.value='Pending';editIndex=null;autoDT();
}

/* RENDER STATUS COLOR */
function statusBadge(status){
return status==='Approved'
?'bg-green-600 text-white'
:'bg-red-600 text-white';
}

/* RENDER */
function render(){
siteTables.innerHTML='';
let summaryData={};

orders.forEach(o=>{
summaryData[o.site]=(summaryData[o.site]||0)+o.total;
});

Object.keys(summaryData).forEach(site=>{
const siteOrders=orders.filter(o=>o.site===site);
const total=summaryData[site];

siteTables.innerHTML+=`
<div class="mt-8">
<h3 class="font-bold text-red-600 mb-2">${site}</h3>

<div class="flex gap-2 mb-2">
<button onclick="siteExcel('${site}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Excel</button>
<button onclick="printSite('${site}')" class="bg-gray-700 text-white px-3 py-1 rounded text-sm">Print</button>
</div>

<table class="w-full border text-sm print-area" id="${site}">
<thead class="bg-gray-200">
<tr>
<th class="border">SN</th>
<th class="border">Date</th>
<th class="border">Vendor</th>
<th class="border">VAT/PAN</th>
<th class="border">Product</th>
<th class="border">Qty</th>
<th class="border">Rate</th>
<th class="border">Total</th>
<th class="border">Status</th>
<th class="border">Action</th>
</tr>
</thead>
<tbody>
${siteOrders.map(o=>`
<tr>
<td class="border p-1">${o.sn}</td>
<td class="border p-1">${o.datetime}</td>
<td class="border p-1">${o.vendor}</td>
<td class="border p-1">${o.vatpan}</td>
<td class="border p-1">${o.product}</td>
<td class="border p-1">${o.qty}</td>
<td class="border p-1">${o.rate}</td>
<td class="border p-1">${o.total}</td>
<td class="border p-1 text-center">
<select onchange="changeStatus(${orders.indexOf(o)}, this.value)"
  class="border rounded text-xs p-1 ${statusBadge(o.status)}">
<option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
<option value="Approved" ${o.status==='Approved'?'selected':''}>Approved</option>
</select>
</td>
<td class="border p-1 text-center space-x-1">
<button onclick="editOrder(${orders.indexOf(o)})" class="bg-blue-600 text-white px-2 py-1 text-xs rounded">Edit</button>
<button onclick="deleteOrder(${orders.indexOf(o)})" class="bg-red-600 text-white px-2 py-1 text-xs rounded">Delete</button>
<button onclick="bill(${orders.indexOf(o)})" class="bg-gray-800 text-white px-2 py-1 text-xs rounded">Bill</button>
</td>
</tr>`).join('')}
</tbody>
</table>

<div class="font-bold mt-2">Total: Rs ${total}</div>
</div>`;
});

/* SUMMARY */
summary.innerHTML='';
let grand=0;
Object.keys(summaryData).forEach(s=>{
grand+=summaryData[s];
summary.innerHTML+=`
<tr>
<td class="border p-2">${s}</td>
<td class="border p-2 font-bold">${summaryData[s]}</td>
</tr>`;
});
grandTotal.innerText=grand;

summaryDT.innerText=
"Upto "+new Date().toLocaleDateString()+" "+new Date().toLocaleTimeString()+
", orders have been placed and money spent.";
}
render();

/* EDIT */
function editOrder(i){
const o=orders[i];
editIndex=i;
datetime.value=o.datetime;
vendor.value=o.vendor;
vatpan.value=o.vatpan;
site.value=o.site;
product.value=o.product;
qty.value=o.qty;
rate.value=o.rate;
orderedBy.value=o.orderedBy;
status.value=o.status;
}

/* DELETE */
function deleteOrder(i){
if(confirm('Delete this order?')){
orders.splice(i,1);
localStorage.setItem('orders',JSON.stringify(orders));
render();
}
}

/* CHANGE STATUS */
function changeStatus(i,value){
orders[i].status=value;
localStorage.setItem('orders',JSON.stringify(orders));
render();
}

/* SITE EXCEL */
function siteExcel(site){
const data=orders.filter(o=>o.site===site);
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,site);
XLSX.writeFile(wb,`${site}.xlsx`);
}

/* SITE PRINT */
function printSite(id){
const c=document.getElementById(id).outerHTML;
document.body.innerHTML=c;
window.print();
location.reload();
}

/* BILL PDF */
function bill(i){
const o=orders[i];
const {jsPDF}=window.jspdf;
const d=new jsPDF();

d.text('Swostik Construction',14,15);
d.text('Vendor Bill',14,22);

d.autoTable({
startY:30,
body:[
['Bill No',o.sn],
['Date',o.datetime],
['Vendor',o.vendor],
['VAT / PAN',o.vatpan],
['Site',o.site],
['Product',o.product],
['Qty',o.qty],
['Rate',o.rate],
['Total',`Rs ${o.total}`],
['Status',o.status]
]
});

let y=d.lastAutoTable.finalY+20;
d.text('Authorized Signature:',14,y);
d.line(60,y+1,140,y+1);
d.save(`Bill-${o.sn}.pdf`);
}

/* SUMMARY PRINT */
function printSummary(){
const c=document.getElementById('summarySection').outerHTML;
document.body.innerHTML=c;
window.print();
location.reload();
}

/* SUMMARY PDF */
function summaryPDF(){
const {jsPDF}=window.jspdf;
const d=new jsPDF();

d.text('Swostik Construction',14,15);
d.text('Site-wise Purchase Summary',14,22);
d.text(summaryDT.innerText,14,28);

d.autoTable({
startY:35,
head:[['Site','Total']],
body:[...summary.children].map(r=>[
r.children[0].innerText,
r.children[1].innerText
])
});

d.text(`Grand Total: Rs ${grandTotal.innerText}`,
14,d.lastAutoTable.finalY+10);

d.save('Site-Summary.pdf');
}

/* SUMMARY EXCEL */
function summaryExcel(){
const data=[...summary.children].map(r=>({
Site:r.children[0].innerText,
Total:r.children[1].innerText
}));
data.push({Site:'Grand Total',Total:grandTotal.innerText});
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Summary');
XLSX.writeFile(wb,'Site-Summary.xlsx');
}
</script>

</body>
</html>




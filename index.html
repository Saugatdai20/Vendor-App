<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swostik Construction - PO System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 p-6">
<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow">

<h1 class="text-2xl font-bold text-red-600 mb-4">Swostik Construction â€“ PO System</h1>

<!-- FORM -->
<div class="grid grid-cols-1 md:grid-cols-10 gap-3">
<input id="datetime" readonly class="border p-2 rounded bg-gray-100">
<input id="vendor" class="border p-2 rounded" placeholder="Vendor Name">
<input id="vatpan" class="border p-2 rounded" placeholder="VAT / PAN No">

<select id="site" class="border p-2 rounded">
<option value="">Select Site</option>
<option>Pepsicola</option>
<option>Thimi</option>
<option>Budhanilkantha</option>
<option>Banepa</option>
</select>

<input id="product" class="border p-2 rounded" placeholder="Product">
<input id="qty" type="number" class="border p-2 rounded" placeholder="Qty">
<input id="rate" type="number" class="border p-2 rounded" placeholder="Rate">
<input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By">

<select id="status" class="border p-2 rounded">
<option>Pending</option>
<option>Approved</option>
</select>
</div>

<button onclick="addItem()" class="mt-3 bg-blue-600 text-white px-4 py-2 rounded">
Add Item
</button>

<table class="w-full border text-sm mt-3">
<thead class="bg-gray-200">
<tr>
<th>Product</th><th>Qty</th><th>Rate</th><th>Total</th><th>Action</th>
</tr>
</thead>
<tbody id="itemTable"></tbody>
</table>

<button onclick="saveOrder()" class="mt-3 bg-red-600 text-white px-6 py-2 rounded">
Save Order
</button>

<!-- SITE TABLES -->
<div id="siteTables" class="mt-10"></div>

<!-- SUMMARY -->
<div class="mt-10 bg-gray-100 p-4 rounded">
<h2 class="font-bold text-red-600 mb-2">Live Site Summary</h2>
<table class="w-full border text-sm">
<thead class="bg-gray-300">
<tr><th>Site</th><th>Total Cost (Rs)</th></tr>
</thead>
<tbody id="summary"></tbody>
<tfoot>
<tr class="font-bold bg-gray-200">
<td>Grand Total</td>
<td id="grandTotal"></td>
</tr>
</tfoot>
</table>
</div>

</div>

<script>
/* AUTO DATE */
function autoDT(){ datetime.value=new Date().toLocaleString(); }
autoDT();

/* DATA */
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let sn = orders.length ? Math.max(...orders.map(o=>o.sn)) + 1 : 1;
let items = [];

/* ADD ITEM */
function addItem(){
if(!product.value||!qty.value||!rate.value) return alert('Fill item fields');
items.push({
product:product.value,
qty:+qty.value,
rate:+rate.value,
total:+qty.value * +rate.value
});
renderItems();
product.value=qty.value=rate.value='';
}

function renderItems(){
itemTable.innerHTML='';
items.forEach((i,idx)=>{
itemTable.innerHTML+=`
<tr>
<td>${i.product}</td>
<td>${i.qty}</td>
<td>${i.rate}</td>
<td>${i.total}</td>
<td>
<button onclick="items.splice(${idx},1);renderItems()" class="text-red-600 text-sm">Delete</button>
</td>
</tr>`;
});
}

/* SAVE ORDER */
function saveOrder(){
if(!vendor.value||!vatpan.value||!site.value||items.length===0)
return alert('Fill vendor info & add items');

items.forEach(it=>{
orders.push({
sn:sn++,
datetime:datetime.value,
vendor:vendor.value,
vatpan:vatpan.value,
site:site.value,
product:it.product,
qty:it.qty,
rate:it.rate,
total:it.total,
orderedBy:orderedBy.value,
status:status.value
});
});

localStorage.setItem('orders',JSON.stringify(orders));
items=[];renderItems();
vendor.value=vatpan.value=orderedBy.value='';
site.value='';status.value='Pending';
autoDT();
render();
}

/* STATUS COLOR */
function badge(status){
return status==='Approved'?'bg-green-600 text-white':'bg-red-600 text-white';
}

/* SMOOTH STATUS CHANGE */
function changeStatus(i, el){
orders[i].status = el.value;
saveLS();
el.className = `border text-xs ${badge(el.value)}`;
}

/* RENDER */
function render(){
siteTables.innerHTML='';
let sum={}, grand=0;

orders.forEach(o=>{
sum[o.site]=(sum[o.site]||0)+o.total;
});

Object.keys(sum).forEach(site=>{
const list=orders.filter(o=>o.site===site);

siteTables.innerHTML+=`
<h3 class="font-bold text-red-600 mt-6">${site}</h3>

<div class="mb-2 flex gap-2">
<button onclick="siteExcel('${site}')"
class="bg-green-600 text-white px-3 py-1 rounded text-sm">Excel</button>

<button onclick="vendorBillPrompt('${site}')"
class="bg-gray-800 text-white px-3 py-1 rounded text-sm">Vendor Bill</button>
</div>

<table class="w-full border text-sm">
<thead class="bg-gray-200">
<tr>
<th>SN</th><th>Date</th><th>Vendor</th><th>Product</th>
<th>Qty</th><th>Rate</th><th>Total</th><th>Status</th><th>PDF</th><th>Delete</th>
</tr>
</thead>
<tbody>
${list.map(o=>`
<tr>
<td>${o.sn}</td>
<td>${o.datetime}</td>
<td>${o.vendor}</td>
<td>${o.product}</td>
<td>${o.qty}</td>
<td>${o.rate}</td>
<td>${o.total}</td>
<td>
<select onchange="changeStatus(${orders.indexOf(o)}, this)" 
class="border text-xs ${badge(o.status)}">
<option value="Pending" ${o.status==='Pending'?'selected':''}>Pending</option>
<option value="Approved" ${o.status==='Approved'?'selected':''}>Approved</option>
</select>
</td>
<td>
<button onclick="itemBill(${orders.indexOf(o)})" class="bg-gray-700 text-white px-2 py-1 text-xs rounded">PDF</button>
</td>
<td>
<button onclick="deleteOrder(${orders.indexOf(o)})" class="text-red-600 text-sm">Delete</button>
</td>
</tr>`).join('')}
</tbody>
</table>

<div class="font-bold mt-1">Total: Rs ${sum[site]}</div>
`;
});

summary.innerHTML='';
Object.keys(sum).forEach(s=>{
summary.innerHTML+=`<tr><td>${s}</td><td>${sum[s]}</td></tr>`;
grand+=sum[s];
});
grandTotal.innerText=grand;
}

/* SAVE LS */
function saveLS(){
localStorage.setItem('orders',JSON.stringify(orders));
render();
}

/* DELETE */
function deleteOrder(i){
if(confirm('Delete this product?')){
orders.splice(i,1);
saveLS();
}
}

/* SITE EXCEL */
function siteExcel(site){
const data=orders.filter(o=>o.site===site);
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,site);
XLSX.writeFile(wb,`${site}.xlsx`);
}

/* ITEM PDF */
function itemBill(i){
const o=orders[i];
const {jsPDF}=window.jspdf;
const d=new jsPDF();
d.text('Swostik Construction',14,15);
d.text('Item Bill',14,22);
d.autoTable({
startY:30,
body:[
['Bill No',o.sn],
['Vendor',o.vendor],
['Site',o.site],
['Product',o.product],
['Qty',o.qty],
['Rate',o.rate],
['Total',`Rs ${o.total}`]
]
});
d.save(`Item-${o.sn}.pdf`);
}

/* VENDOR COMBINED BILL */
function vendorBillPrompt(site){
const v = prompt('Enter Vendor Name');
if(!v) return;
vendorBill(site,v);
}

function vendorBill(site,vendor){
const data = orders.filter(o=>o.site===site && o.vendor===vendor);
if(data.length===0) return alert('No data found');

let total = data.reduce((s,o)=>s+o.total,0);
const {jsPDF}=window.jspdf;
const d=new jsPDF();

d.text('Swostik Construction',14,15);
d.text('Vendor Combined Bill',14,22);
d.text(`Vendor: ${vendor}`,14,30);
d.text(`Site: ${site}`,14,36);

d.autoTable({
startY:42,
head:[['Product','Qty','Rate','Total']],
body:data.map(o=>[o.product,o.qty,o.rate,o.total])
});

d.text(`Grand Total: Rs ${total}`,14,d.lastAutoTable.finalY+10);
d.save(`Vendor-${vendor}-${site}.pdf`);
}

render();
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swostik Construction - Vendor Order & PO System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6">

  <!-- Header -->
  <div class="flex items-center gap-4 mb-6">
    <!-- Logo -->
    <div class="w-20 h-20 flex items-center justify-center">
      <img src="logo.jpg" alt="Swostik Construction Logo" class="w-full h-full object-contain rounded-full">
    </div>
    <div>
      <h1 class="text-2xl font-bold text-red-600">Swostik Construction</h1>
      <p class="text-gray-500">Vendor Order / Purchase Order System</p>
    </div>
  </div>

  <!-- Form -->
  <div class="grid grid-cols-1 md:grid-cols-7 gap-3">

    <select id="vendor" class="border p-2 rounded">
      <option value="">Select Vendor</option>
      <option>ABC Suppliers</option>
      <option>Shiva Cement Store</option>
      <option>Himal Steel Traders</option>
      <option>Everest Hardware</option>
    </select>

    <select id="site" class="border p-2 rounded">
      <option value="">Select Site</option>
      <option>Site A - Kathmandu</option>
      <option>Site B - Bhaktapur</option>
      <option>Site C - Lalitpur</option>
    </select>

    <input id="product" class="border p-2 rounded" placeholder="Product" />
    <input id="quantity" type="number" class="border p-2 rounded" placeholder="Qty" />
    <input id="price" type="number" class="border p-2 rounded" placeholder="Price" />
    <input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By" />

    <select id="status" class="border p-2 rounded">
      <option>Pending</option>
      <option>Approved</option>
    </select>
  </div>

  <button onclick="addOrder()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded">Add Order</button>

  <!-- Table -->
  <div class="overflow-x-auto mt-6">
    <table id="orderTable" class="w-full text-sm border">
      <thead class="bg-gray-200">
        <tr>
          <th class="border p-2">SN</th>
          <th class="border p-2">Date</th>
          <th class="border p-2">Time</th>
          <th class="border p-2">Vendor</th>
          <th class="border p-2">Site</th>
          <th class="border p-2">Product</th>
          <th class="border p-2">Qty</th>
          <th class="border p-2">Price</th>
          <th class="border p-2">Total</th>
          <th class="border p-2">Ordered By</th>
          <th class="border p-2">Status</th>
          <th class="border p-2">Approve</th>
          <th class="border p-2">Bill</th>
          <th class="border p-2">Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Buttons -->
  <div class="flex flex-wrap gap-4 mt-6">
    <button onclick="exportPDF()" class="bg-red-600 text-white px-4 py-2 rounded">Export PO PDF</button>
    <button onclick="exportExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Export Excel</button>
    <button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">Print</button>
  </div>

</div>

<script>
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let sn = orders.length ? Math.max(...orders.map(o => o.sn)) + 1 : 1;

const vendorEl = document.getElementById('vendor');
const siteEl = document.getElementById('site');
const productEl = document.getElementById('product');
const quantityEl = document.getElementById('quantity');
const priceEl = document.getElementById('price');
const orderedByEl = document.getElementById('orderedBy');
const statusEl = document.getElementById('status');

function renderTable() {
  const tbody = document.querySelector('#orderTable tbody');
  tbody.innerHTML = '';

  orders.forEach(o => {
    const row = tbody.insertRow();
    row.innerHTML = `
      <td class="border p-2">${o.sn}</td>
      <td class="border p-2">${o.date}</td>
      <td class="border p-2">${o.time}</td>
      <td class="border p-2">${o.vendor}</td>
      <td class="border p-2">${o.site}</td>
      <td class="border p-2">${o.product}</td>
      <td class="border p-2">${o.qty}</td>
      <td class="border p-2">${o.price}</td>
      <td class="border p-2">${o.total}</td>
      <td class="border p-2">${o.orderedBy}</td>
      <td class="border p-2">${o.status}</td>
      <td class="border p-2 text-center">
        <button onclick="approveOrder(${o.sn})" class="bg-emerald-600 text-white px-2 py-1 rounded text-xs">Approve</button>
      </td>
      <td class="border p-2 text-center">
        <button onclick="downloadBill(${o.sn})" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Bill PDF</button>
      </td>
      <td class="border p-2 text-center">
        <button onclick="deleteOrder(${o.sn})" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
      </td>
    `;
  });
}

renderTable();

function addOrder() {
  if (!vendorEl.value || !siteEl.value || !productEl.value || !quantityEl.value || !priceEl.value || !orderedByEl.value) {
    alert('Fill all fields');
    return;
  }

  const now = new Date();
  const order = {
    sn: sn++,
    date: now.toLocaleDateString(),
    time: now.toLocaleTimeString(),
    vendor: vendorEl.value,
    site: siteEl.value,
    product: productEl.value,
    qty: quantityEl.value,
    price: priceEl.value,
    total: quantityEl.value * priceEl.value,
    orderedBy: orderedByEl.value,
    status: statusEl.value
  };

  orders.push(order);
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable();

  productEl.value = quantityEl.value = priceEl.value = orderedByEl.value = '';
}

function approveOrder(sn) {
  const order = orders.find(o => o.sn === sn);
  if (!order) return;
  order.status = 'Approved';
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable();
}

function deleteOrder(sn) {
  if (!confirm('Are you sure you want to delete this order?')) return;
  orders = orders.filter(o => o.sn !== sn);
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTable();
}

function downloadBill(sn) {
  const order = orders.find(o => o.sn === sn);
  if (!order) return;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text('Swostik Construction', 14, 20);
  doc.setFontSize(10);
  doc.text('Vendor Bill', 14, 27);

  doc.autoTable({
    startY: 35,
    head: [['Field', 'Details']],
    body: [
      ['Bill No', order.sn],
      ['Date', order.date + ' ' + order.time],
      ['Vendor', order.vendor],
      ['Site', order.site],
      ['Product', order.product],
      ['Quantity', order.qty],
      ['Price', order.price],
      ['Total Amount', order.total],
      ['Ordered By', order.orderedBy],
      ['Status', order.status]
    ]
  });

  doc.text('Authorized Signature', 14, doc.lastAutoTable.finalY + 20);
  doc.save(`Swostik-Bill-${order.sn}.pdf`);
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l');
  doc.text('Swostik Construction - Purchase Orders', 14, 15);
  doc.autoTable({ html: '#orderTable', startY: 25 });
  doc.save('swostik-purchase-orders.pdf');
}

function exportExcel() {
  const table = document.getElementById('orderTable').cloneNode(true);

  // Replace buttons with plain text
  Array.from(table.querySelectorAll('button')).forEach(btn => {
    btn.parentNode.textContent = btn.textContent;
  });

  const wb = XLSX.utils.table_to_book(table, { sheet: 'Orders' });
  const ws = wb.Sheets['Orders'];

  // Column widths to avoid ######
  ws['!cols'] = [
    { wch: 5 }, { wch: 12 }, { wch: 12 }, { wch: 18 }, { wch: 20 },
    { wch: 15 }, { wch: 8 }, { wch: 10 }, { wch: 12 }, { wch: 15 },
    { wch: 12 }, { wch: 10 }, { wch: 10 }, { wch: 10 }
  ];

  XLSX.writeFile(wb, 'swostik-orders.xlsx');
}
</script>

</body>
</html>

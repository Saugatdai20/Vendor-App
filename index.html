<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swostik Construction - PO System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- âœ… Accurate Nepali Date Converter -->
<script src="https://cdn.jsdelivr.net/npm/nepali-date-converter@2.3.0/dist/nepali-date-converter.umd.js"></script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-7xl mx-auto bg-white p-6 rounded-2xl shadow-xl">

<!-- HEADER -->
<div class="flex gap-4 mb-6">
  <img src="logo.jpg" class="w-20 h-20 object-contain rounded-full">
  <div>
    <h1 class="text-2xl font-bold text-red-600">Swostik Construction</h1>
    <p class="text-gray-500">Vendor Order / Purchase Order System</p>
  </div>
</div>

<!-- FORM -->
<div class="grid grid-cols-1 md:grid-cols-8 gap-3">

  <input id="adDate" type="date" class="border p-2 rounded">

  <input id="vendor" list="vendorList" class="border p-2 rounded" placeholder="Vendor Name">
  <datalist id="vendorList"></datalist>

  <select id="site" class="border p-2 rounded">
    <option value="">Select Site</option>
    <option>Pepsicola Site</option>
    <option>Thimi Site</option>
    <option>Budhanilkantha Site</option>
    <option>Banepa Site</option>
  </select>

  <input id="product" class="border p-2 rounded" placeholder="Product">
  <input id="quantity" type="number" class="border p-2 rounded" placeholder="Qty">
  <input id="price" type="number" class="border p-2 rounded" placeholder="Rate">
  <input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By">

  <select id="status" class="border p-2 rounded">
    <option>Pending</option>
    <option>Approved</option>
  </select>

</div>

<button onclick="addOrder()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded">
Add Order
</button>

<!-- SITE TABLES -->
<div id="siteTables" class="mt-8"></div>

<!-- SUMMARY -->
<h2 class="text-lg font-bold mt-10 mb-2 text-red-600">Site-Wise Total Summary</h2>
<table class="w-full border text-sm">
<thead class="bg-gray-200">
<tr>
<th class="border p-2">Site</th>
<th class="border p-2">Total Amount</th>
</tr>
</thead>
<tbody id="siteSummary"></tbody>
</table>

<!-- EXPORT -->
<div class="flex gap-4 mt-6">
<button onclick="exportAllPDF()" class="bg-red-600 text-white px-4 py-2 rounded">Export All PDF</button>
<button onclick="exportAllExcel()" class="bg-green-600 text-white px-4 py-2 rounded">Export All Excel</button>
<button onclick="window.print()" class="bg-gray-700 text-white px-4 py-2 rounded">Print</button>
</div>

</div>

<script>
/* ---------- AUTO AD DATE ---------- */
const adDateEl = document.getElementById('adDate');
const today = new Date().toISOString().split('T')[0];
adDateEl.value = today;

/* ---------- ACCURATE NEPALI DATE + TIME ---------- */
function getNepaliDate(adDate) {
  const ad = adDate ? new Date(adDate) : new Date();

  const bs = NepaliFunctions.AD2BS({
    year: ad.getFullYear(),
    month: ad.getMonth() + 1,
    day: ad.getDate()
  });

  const time = ad.toLocaleTimeString('en-US', {
    hour: '2-digit',
    minute: '2-digit'
  });

  return `${bs.year}-${String(bs.month).padStart(2,'0')}-${String(bs.day).padStart(2,'0')} ${time}`;
}

/* ---------- DATA ---------- */
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let sn = orders.length ? Math.max(...orders.map(o => o.sn)) + 1 : 1;

const vendorEl = document.getElementById('vendor');
const siteEl = document.getElementById('site');
const productEl = document.getElementById('product');
const qtyEl = document.getElementById('quantity');
const priceEl = document.getElementById('price');
const orderedByEl = document.getElementById('orderedBy');
const statusEl = document.getElementById('status');

/* ---------- ADD ORDER ---------- */
function addOrder() {
  if (!adDateEl.value || !vendorEl.value || !siteEl.value || !productEl.value || !qtyEl.value || !priceEl.value)
    return alert('Fill all fields');

  orders.push({
    sn: sn++,
    ad: adDateEl.value,
    bs: getNepaliDate(adDateEl.value),
    vendor: vendorEl.value,
    site: siteEl.value,
    product: productEl.value,
    qty: qtyEl.value,
    price: priceEl.value,
    total: qtyEl.value * priceEl.value,
    orderedBy: orderedByEl.value,
    status: statusEl.value
  });

  localStorage.setItem('orders', JSON.stringify(orders));

  vendorEl.value = productEl.value = qtyEl.value = priceEl.value = orderedByEl.value = '';
  adDateEl.value = today;

  render();
}

/* ---------- RENDER ---------- */
function render() {
  renderVendorList();
  renderSiteTables();
  renderSummary();
}
render();

/* ---------- VENDOR LIST ---------- */
function renderVendorList() {
  const list = document.getElementById('vendorList');
  const vendors = [...new Set(orders.map(o => o.vendor))];
  list.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
}

/* ---------- SITE TABLES ---------- */
function renderSiteTables() {
  const container = document.getElementById('siteTables');
  container.innerHTML = '';

  const sites = [...new Set(orders.map(o => o.site))];

  sites.forEach(site => {
    const siteOrders = orders.filter(o => o.site === site);
    const total = siteOrders.reduce((s, o) => s + o.total, 0);

    const rows = siteOrders.map(o => `
      <tr>
        <td class="border p-1">${o.sn}</td>
        <td class="border p-1">${o.ad}</td>
        <td class="border p-1">${o.bs}</td>
        <td class="border p-1">${o.vendor}</td>
        <td class="border p-1">${o.product}</td>
        <td class="border p-1">${o.qty}</td>
        <td class="border p-1">${o.price}</td>
        <td class="border p-1">${o.total}</td>
        <td class="border p-1">${o.status}</td>
        <td class="border p-1 text-center">
          <button onclick="billPDF(${o.sn})" class="bg-blue-600 text-white px-2 py-1 text-xs rounded">Bill</button>
        </td>
      </tr>
    `).join('');

    container.innerHTML += `
    <div class="mt-8">
      <h3 class="font-bold text-red-600 mb-2">${site}</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border">SN</th><th class="border">AD</th><th class="border">BS</th>
            <th class="border">Vendor</th><th class="border">Product</th>
            <th class="border">Qty</th><th class="border">Rate</th>
            <th class="border">Total</th><th class="border">Status</th><th class="border">Bill</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>

      <div class="flex gap-3 mt-2">
        <button onclick="sitePDF('${site}')" class="bg-red-600 text-white px-4 py-1 rounded">Site PDF</button>
        <button onclick="siteExcel('${site}')" class="bg-green-600 text-white px-4 py-1 rounded">Site Excel</button>
        <span class="font-bold ml-auto">Total: Rs ${total}</span>
      </div>
    </div>`;
  });
}

/* ---------- SUMMARY ---------- */
function renderSummary() {
  const body = document.getElementById('siteSummary');
  body.innerHTML = '';

  [...new Set(orders.map(o => o.site))].forEach(site => {
    const total = orders.filter(o => o.site === site).reduce((s, o) => s + o.total, 0);
    body.innerHTML += `
      <tr>
        <td class="border p-2">${site}</td>
        <td class="border p-2 font-bold">${total}</td>
      </tr>`;
  });
}

/* ---------- BILL PDF ---------- */
function billPDF(sn) {
  const o = orders.find(x => x.sn === sn);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text('Swostik Construction - Vendor Bill', 14, 20);
  doc.autoTable({
    startY: 30,
    body: [
      ['Bill No', o.sn],
      ['AD Date', o.ad],
      ['BS Date', o.bs],
      ['Vendor', o.vendor],
      ['Site', o.site],
      ['Product', o.product],
      ['Qty', o.qty],
      ['Rate', o.price],
      ['Total', o.total]
    ]
  });

  doc.text('Authorized Signature:', 14, doc.lastAutoTable.finalY + 20);
  doc.save(`Bill-${o.sn}.pdf`);
}

/* ---------- SITE PDF ---------- */
function sitePDF(site) {
  const data = orders.filter(o => o.site === site);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l');

  doc.text(`Site Bills - ${site}`, 14, 15);
  doc.autoTable({
    startY: 25,
    head: [['SN', 'AD', 'BS', 'Vendor', 'Product', 'Qty', 'Rate', 'Total']],
    body: data.map(o => [o.sn, o.ad, o.bs, o.vendor, o.product, o.qty, o.price, o.total])
  });

  const total = data.reduce((s, o) => s + o.total, 0);
  doc.text(`Total Amount: Rs ${total}`, 14, doc.lastAutoTable.finalY + 10);
  doc.text('Authorized Signature:', 14, doc.lastAutoTable.finalY + 25);

  doc.save(`${site}-Bills.pdf`);
}

/* ---------- SITE EXCEL ---------- */
function siteExcel(site) {
  const data = orders.filter(o => o.site === site);
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, site);
  XLSX.writeFile(wb, `${site}-Bills.xlsx`);
}

/* ---------- EXPORT ALL ---------- */
function exportAllPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l');

  doc.text('All Orders', 14, 15);
  doc.autoTable({
    startY: 25,
    head: [['SN','AD','BS','Vendor','Site','Product','Qty','Rate','Total']],
    body: orders.map(o => [o.sn, o.ad, o.bs, o.vendor, o.site, o.product, o.qty, o.price, o.total])
  });

  doc.save('All-Orders.pdf');
}

function exportAllExcel() {
  const ws = XLSX.utils.json_to_sheet(orders);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Orders');
  XLSX.writeFile(wb, 'All-Orders.xlsx');
}
</script>

</body>
</html>




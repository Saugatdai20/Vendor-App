<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swostik Construction - PO System</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body class="bg-gray-100 p-6">

<div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6">

<!-- HEADER -->
<div class="flex gap-4 mb-6">
  <img src="logo.jpg" class="w-20 h-20 object-contain rounded-full">
  <div>
    <h1 class="text-2xl font-bold text-red-600">Swostik Construction</h1>
    <p class="text-gray-500">Vendor Order / Purchase Order System</p>
  </div>
</div>

<!-- FORM -->
<div class="grid grid-cols-1 md:grid-cols-7 gap-3">
  <input id="vendor" list="vendorList" class="border p-2 rounded" placeholder="Vendor Name">
  <datalist id="vendorList"></datalist>

  <select id="site" class="border p-2 rounded">
    <option value="">Select Site</option>
    <option>Pepsicola Site</option>
    <option>Thimi Site</option>
    <option>Budhanilkantha Site</option>
    <option>Banepa Site</option>
  </select>

  <input id="product" class="border p-2 rounded" placeholder="Product">
  <input id="quantity" type="number" class="border p-2 rounded" placeholder="Qty">
  <input id="price" type="number" class="border p-2 rounded" placeholder="Price">
  <input id="orderedBy" class="border p-2 rounded" placeholder="Ordered By">

  <select id="status" class="border p-2 rounded">
    <option>Pending</option>
    <option>Approved</option>
  </select>
</div>

<button onclick="addOrder()" class="mt-4 bg-red-600 text-white px-6 py-2 rounded">
Add Order
</button>

<!-- SITE TABLES -->
<div id="tables" class="mt-8 space-y-10"></div>

</div>

<script>
/* ---------------- NEPALI DATE ---------------- */
function getNepaliDate() {
  const d = new Date();
  let y = d.getFullYear() + 56;
  let m = d.getMonth() + 9;
  let day = d.getDate();
  if (m > 12) { m -= 12; y++; }
  return `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
}

/* ---------------- DATA ---------------- */
let orders = JSON.parse(localStorage.getItem('orders')) || [];
let sn = orders.length ? Math.max(...orders.map(o => o.sn)) + 1 : 1;

const vendorEl = document.getElementById('vendor');
const siteEl = document.getElementById('site');
const productEl = document.getElementById('product');
const quantityEl = document.getElementById('quantity');
const priceEl = document.getElementById('price');
const orderedByEl = document.getElementById('orderedBy');
const statusEl = document.getElementById('status');

/* ---------------- ADD ORDER ---------------- */
function addOrder() {
  if (!vendorEl.value || !siteEl.value || !productEl.value || !quantityEl.value || !priceEl.value) {
    alert('Fill all fields');
    return;
  }

  orders.push({
    sn: sn++,
    adDate: new Date().toLocaleDateString(),
    bsDate: getNepaliDate(),
    vendor: vendorEl.value,
    site: siteEl.value,
    product: productEl.value,
    qty: quantityEl.value,
    price: priceEl.value,
    total: quantityEl.value * priceEl.value,
    orderedBy: orderedByEl.value,
    status: statusEl.value
  });

  localStorage.setItem('orders', JSON.stringify(orders));
  renderTables();

  vendorEl.value = productEl.value = quantityEl.value = priceEl.value = orderedByEl.value = '';
}

/* ---------------- RENDER SITE TABLES ---------------- */
function renderTables() {
  const container = document.getElementById('tables');
  container.innerHTML = '';

  const sites = [...new Set(orders.map(o => o.site))];

  sites.forEach(site => {
    const siteOrders = orders.filter(o => o.site === site);

    let html = `
    <div>
      <h2 class="text-xl font-bold text-red-600 mb-2">${site}</h2>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">SN</th>
            <th class="border p-2">AD</th>
            <th class="border p-2">BS</th>
            <th class="border p-2">Vendor</th>
            <th class="border p-2">Product</th>
            <th class="border p-2">Qty</th>
            <th class="border p-2">Rate</th>
            <th class="border p-2">Total</th>
            <th class="border p-2">Status</th>
            <th class="border p-2">Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    siteOrders.forEach(o => {
      html += `
      <tr>
        <td class="border p-2">${o.sn}</td>
        <td class="border p-2">${o.adDate}</td>
        <td class="border p-2">${o.bsDate}</td>
        <td class="border p-2">${o.vendor}</td>
        <td class="border p-2">${o.product}</td>
        <td class="border p-2">${o.qty}</td>
        <td class="border p-2">${o.price}</td>
        <td class="border p-2 font-bold">${o.total}</td>
        <td class="border p-2">${o.status}</td>
        <td class="border p-2 text-center">
          ${o.status === 'Pending'
            ? `<button onclick="approveOrder(${o.sn})" class="bg-green-600 text-white px-2 py-1 text-xs rounded">Approve</button>`
            : `<span class="text-green-700 font-semibold">Approved</span>`
          }
        </td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
    container.innerHTML += html;
  });

  renderVendorList();
}

renderTables();

/* ---------------- APPROVE ---------------- */
function approveOrder(sn) {
  const order = orders.find(o => o.sn === sn);
  if (!order) return;
  order.status = 'Approved';
  localStorage.setItem('orders', JSON.stringify(orders));
  renderTables();
}

/* ---------------- VENDOR AUTOCOMPLETE ---------------- */
function renderVendorList() {
  const list = document.getElementById('vendorList');
  const vendors = [...new Set(orders.map(o => o.vendor))];
  list.innerHTML = vendors.map(v => `<option value="${v}">`).join('');
}
</script>

</body>
</html>
